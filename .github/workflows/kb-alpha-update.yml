name: Alpha Update

permissions:
  contents: write
  issues: write
  pull-requests: write

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * 2" # Every Tuesday at 00:00 UTC

jobs:
  alpha-update:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: stable

    - name: Configure Git
      run: |
        git config --local user.name "github-actions[bot]"
        git config --local user.email "github-actions[bot]@users.noreply.github.com"

    - name: Install Kubebuilder
      run: |
        git clone --depth 1 --branch master \
          https://github.com/kubernetes-sigs/kubebuilder.git /tmp/kubebuilder
        cd /tmp/kubebuilder
        make build
        sudo cp bin/kubebuilder /usr/local/bin/
        kubebuilder version

    - name: Run kubebuilder alpha update
      run: |
        kubebuilder alpha update \
          --force \
          --restore-path .github/workflows \
          --push \
          --open-gh-issue

    - name: Determine update issue number
      id: find-issue
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        set -e
        echo "Searching for latest Kubebuilder update issue..."
        data=$(gh issue list --state open --author github-actions[bot] --limit 40 --json number,title,createdAt)
        issue_number=$(echo "$data" | jq -r '[ .[] 
          | select(.title|test("^update kubebuilder from version v[0-9.]+ to version v[0-9.]+$")) 
          ] | sort_by(.createdAt) | last.number // empty')
        if [ -z "$issue_number" ]; then
          echo "No matching issue found; skipping comment."
        else
          echo "Found issue #$issue_number"
        fi
        echo "issue_number=$issue_number" >> "$GITHUB_OUTPUT"

    - name: Create compact patch of last commit
      if: steps.find-issue.outputs.issue_number != ''
      run: |
        set -e
        echo "Current branch: $(git rev-parse --abbrev-ref HEAD)"
        echo "Capturing last commit diff..."
        git show --no-color --unified=0 --pretty=format: --no-renames HEAD > update.patch
        # Trim to 200k chars to keep prompt reasonable
        head -c 200000 update.patch > update.patch.trim
        echo "Patch size (bytes): $(wc -c < update.patch.trim)"

    - name: Prepare model prompt
      if: steps.find-issue.outputs.issue_number != ''
      run: |
        cat > prompt.txt <<'EOF'
        You are a concise change summarization assistant.

        Task:
        Summarize the provided unified diff (single commit from an automated Kubebuilder alpha scaffold update) for a GitHub issue comment.

        Include:
        1. One-line overview (what & why).
        2. Bullet list of notable changes grouped roughly by directory or concern.
        3. Note any occurrences of conflict markers if present (e.g., <<<<<<<).
        4. Quick checklist:
           - [ ] Build & generate succeed
           - [ ] Tests pass
           - [ ] Manual review of CRD / RBAC changes
        5. Keep <= 170 words. No raw diff. Markdown only.

        ---- DIFF BELOW ----
        EOF
        cat update.patch.trim >> prompt.txt

    - name: Generate summary with GitHub Models
      id: model
      if: steps.find-issue.outputs.issue_number != ''
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        MODEL_ID: openai/gpt-4o-mini
      run: |
        set -e
        jq -Rn --rawfile prompt prompt.txt '{
          model: env.MODEL_ID,
          messages: [{role:"user", content:$prompt}],
          max_tokens: 500,
          temperature: 0.2
        }' > req.json
        curl -sS https://models.github.ai/inference/chat/completions \
          -H "Content-Type: application/json" \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
          --data @req.json -o resp.json
        summary=$(jq -r '.choices[0].message.content // empty' resp.json)
        if [ -z "$summary" ]; then
          echo "Model returned empty content; using fallback."
          summary="Automated summary unavailable. Please review the latest commit diff for the Kubebuilder update."
        fi
        printf "%s\n" "$summary" > COMMENT.md
        echo "chars=$(wc -c < COMMENT.md)" >> "$GITHUB_OUTPUT"

    - name: Post comment to issue
      if: steps.find-issue.outputs.issue_number != ''
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        set -e
        issue=${{ steps.find-issue.outputs.issue_number }}
        echo "Posting summary comment to issue #$issue"
        gh api repos/${{ github.repository }}/issues/$issue/comments -f body=@COMMENT.md

